# AI Commit Context

## Current repo state
- Repository: `~/dot-files`
- Base commit before these changes: `bd8b78a`
- These changes are currently **not committed**.

## What was done
The bootstrap/install/apply flow was hardened to be safer, more fault-tolerant, and easier for automated execution.

### 1. Bootstrap hardening
File: `bootstrap.sh`
- Added argument support:
  - `--yes`
  - `--dry-run`
  - `--skip-install`
  - `--skip-apply`
  - `--skip-autodetect`
- Added preflight checks (Arch guard, required tools, sudo gate).
- Added step runner with critical vs non-critical handling.
- Added safer sudo logic:
  - sudo auth only required when install step is actually run.

### 2. Dependency installer hardening
File: `scripts/install_dependencies.sh`
- Added argument support:
  - `--yes`
  - `--dry-run`
- Added validation checks (`pacman`, manifests, sudo when needed).
- Added fallback strategy for installs:
  - bulk install first
  - package-by-package retry on failure
- Added resilient handling when tools are missing (`yay`, `npm`, `pipx`, `python`).
- Added warnings instead of hard-stop for optional layers.

### 3. Dotfiles apply hardening
File: `scripts/apply_dotfiles.sh`
- Added argument support:
  - `--dry-run`
- Added source/tool validation (`find`, `tar`, source dir).
- Added per-item backup/apply failure accounting.
- Added targeted backup fallbacks for lock-prone paths:
  - `.local` (backup only `~/.local/share/rofi`)
  - `waybar-scripts` (exclude `traffic_rs/target`)
- Added non-fatal service enable behavior.
- Added executable bit pass for new helper scripts under `~/.config/dotfiles`.

### 4. Dynamic post-install autodetect
New file: `scripts/post_install_autodetect.sh`
- Added argument support:
  - `--dry-run`
- Detects dynamically:
  - default network interface
  - default audio source
  - display manager
  - lock manager
  - monitor layout (from `hyprctl` when available)
- Writes detected values to:
  - `~/.config/dotfiles/autodetect.env`
- Patches config dynamically:
  - Waybar `TRAFFIC_IFACE` in `~/.config/waybar/UserModules`
  - Hypr voice `VOICE_SOURCE` in `~/.config/hypr/configs/Keybinds.conf`
  - Hypr monitor file `~/.config/hypr/monitors.conf` (when possible)
- Adds shell hook sourcing into `.bashrc` and `.zshrc` if missing.

### 5. Runtime ops helpers
New files:
- `home/.config/dotfiles/healthcheck.sh`
- `home/.config/dotfiles/session_tools.sh`

Capabilities:
- `rice-check`: health/status report for Hyprland/Wayland/portal/GPU/session
- `rice-restart [stack|hypr|waybar|portal]`: restart common session components with fallbacks
- `rice-autodetect`: rerun dynamic detection script

### 6. Lock screen manager fallback behavior
File: `home/.config/hypr/scripts/LockScreen.sh`
- Uses detected lock manager from `autodetect.env`.
- Tries in order based on detection (`hyprlock`/`swaylock`/`gtklock`/`i3lock`).
- Falls back to `loginctl lock-session`.

### 7. Shell integration
Files:
- `home/.bashrc`
- `home/.zshrc`

Changes:
- Source `~/.config/dotfiles/session_tools.sh` when present.
- Updated `.bashrc` rover source path to portable `$HOME` form.

### 8. Documentation updates
File: `README.md`
- Added safe usage options (`--dry-run`, `--yes`).
- Added autodetect step description.
- Added runtime command documentation.
- Added safety model section.

## Files changed in working tree
Modified:
- `README.md`
- `bootstrap.sh`
- `home/.bashrc`
- `home/.config/hypr/scripts/LockScreen.sh`
- `home/.zshrc`
- `scripts/apply_dotfiles.sh`
- `scripts/install_dependencies.sh`

Untracked/new:
- `home/.config/dotfiles/healthcheck.sh`
- `home/.config/dotfiles/session_tools.sh`
- `scripts/post_install_autodetect.sh`

## Validation and execution performed
### Syntax validation
Ran successfully:
- `bash -n bootstrap.sh`
- `bash -n scripts/install_dependencies.sh`
- `bash -n scripts/apply_dotfiles.sh`
- `bash -n scripts/post_install_autodetect.sh`
- `bash -n home/.config/dotfiles/healthcheck.sh`
- `bash -n home/.config/dotfiles/session_tools.sh`
- `bash -n home/.config/hypr/scripts/LockScreen.sh`

### Dry-run validation
Ran:
- `bash ./bootstrap.sh --dry-run --yes`
Result:
- All steps rendered planned commands correctly.

### Real safe execution (without package churn)
Ran:
- `bash ./bootstrap.sh --yes --skip-install`
Result:
- Apply step completed successfully with backup.
- Autodetect completed successfully and detected:
  - Interface: `enp4s0`
  - Voice source: `alsa_input.pci-0000_00_1f.3.pro-input-0`
  - Display manager: `sddm`
  - Lock manager: `hyprlock`

## Recommended commit message
`Harden bootstrap with validation, autodetect patching, and runtime recovery tools`

## Recommended next actions for next AI
1. Review diff quickly for style/wording preferences.
2. Commit all current working tree changes.
3. Push to `main`.
4. Optionally run full install path on a target machine:
   - `bash ./bootstrap.sh --yes`
